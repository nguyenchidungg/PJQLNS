create database QLNS
go

use QLNS
set dateformat DMY
go

create table CHITIETHOADON
(
	MAHOADON int not null,
	MASACH char(7),
	SOLUONG int,
	GIATIEN int,
	THANHTIEN int
)
go
INSERT INTO CHITIETHOADON VALUES (25046, 'SA00172', 3, 200000, 600000);
INSERT INTO CHITIETHOADON VALUES (25046, 'SA00932', 1, 105000, 105000);
INSERT INTO CHITIETHOADON VALUES (51499, 'SA00303', 5, 105000, 525000);
INSERT INTO CHITIETHOADON VALUES (74456, 'SA00768', 2, 80000, 160000);
INSERT INTO CHITIETHOADON VALUES (74456, 'SA00596', 2, 83000, 166000);
INSERT INTO CHITIETHOADON VALUES (76437, 'SA00768', 1, 80000, 80000);
INSERT INTO CHITIETHOADON VALUES (76437, 'SA00138', 2, 120000, 240000);
INSERT INTO CHITIETHOADON VALUES (77543, 'SA00303', 4, 105000, 420000);
select * from CHITIETHOADON


create table HOADON
(
	MAHOADON int primary key not null,
	TENKHACHHANG nvarchar(50),
	NGAYLAP datetime,
	TONGTIEN decimal(10, 2) 
)
go
INSERT INTO HOADON VALUES ((SELECT RAND()*(100000-9999)+9999), 'Tran Van Dat', '2020/12/5 15:30:19', 705000);
INSERT INTO HOADON VALUES ((SELECT RAND()*(100000-9999)+9999), 'Le Thi Cuc', '2019/1/6 7:15:51', 525000);
INSERT INTO HOADON VALUES ((SELECT RAND()*(100000-9999)+9999), 'Nguyen Van An', '2021/4/1 11:00:39', 326000);
INSERT INTO HOADON VALUES ((SELECT RAND()*(100000-9999)+9999), 'Le Van Nam', '2021/2/2 18:37:12', 320000);
INSERT INTO HOADON VALUES ((SELECT RAND()*(100000-9999)+9999), 'Tran Van Trung', '2021/06/29 20:50:33', 420000);
Select * From HOADON

create table KHO
(
	MASACH char(7) primary key not null,
	SOLUONG int
)
go
INSERT INTO KHO VALUES ('SA00135', 500);
INSERT INTO KHO VALUES ('SA00267', 950);
INSERT INTO KHO VALUES ('SA00600', 710);
INSERT INTO KHO VALUES ('SA00650', 420);
INSERT INTO KHO VALUES ('SA00744', 1000);
INSERT INTO KHO VALUES ('SA00933', 300);
INSERT INTO KHO VALUES ('SA00935', 650);
INSERT INTO KHO VALUES ('SA00993', 450);
Select * From KHO

create table LINHVUC
(
	TENLINHVUC nvarchar(30) primary key not null
)
go
INSERT INTO LINHVUC VALUES ('Tieu Thuyet');
INSERT INTO LINHVUC VALUES ('Sach Tu Duy');
INSERT INTO LINHVUC VALUES ('Sach Tam Ly');
INSERT INTO LINHVUC VALUES ('Truyen Trinh Tham');
Select * from LINHVUC

create table LOAISACH
(
	TENLOAISACH nvarchar(30) primary key not null
)
go
INSERT INTO LOAISACH VALUES ('Sach Tieng Viet');
INSERT INTO LOAISACH VALUES ('Sach Tieng Anh');
Select * from LOAISACH

create table NHAXUATBAN
(
	TENNHAXUATBAN nvarchar(50) primary key not null
)
go
INSERT INTO NHAXUATBAN VALUES ('NXB Ha Noi');
INSERT INTO NHAXUATBAN VALUES ('NXB Kim Dong');
INSERT INTO NHAXUATBAN VALUES ('NXB Tuoi Tre');
INSERT INTO NHAXUATBAN VALUES ('NXB Giao Duc');
Select * from NHAXUATBAN

create table SACH
(
	MASACH char(7) primary key not null,
	TENSACH nvarchar(100),
	MATG int not null,
	TENLINHVUC nvarchar(30),
	TENLOAISACH nvarchar(30),
	GIAMUA int,
	GIABIA int,
	LANTAIBAN int,
	TENNHAXUATBAN nvarchar(50),
	NAMXUATBAN datetime
)
go
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Soi Doi Lot Cuu', 1539, 'Tieu Thuyet', 'Sach Tieng Viet', 65000, 105000, 2, 'NXB Ha Noi', '2018/7/7 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Dac Nhan Tam', 2365, 'Sach Tu Duy', 'Sach Tieng Viet', 47000, 83000, 7, 'NXB Kim Dong', '2020/7/3 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Hieu Biet Ve Tam Ly Hoc', 2614, 'Sach Tam Ly', 'Sach Tieng Viet', 65000, 105000, 4, 'NXB Tuoi Tre', '2017/2/1 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Hoc Tieng Anh Hieu Qua', 4634, 'Sach Tu Duy', 'Sach Tieng Viet', 125000, 200000, 2, 'NXB Giao Duc', '2021/6/12 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('When we get older', 1539, 'Tieu thuyet', 'Sach Tieng Anh', 77000, 120000, 1, 'NXB Ha Noi', '2019/1/7 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Family', 1539, 'Tieu thuyet', 'Sach Tieng Anh', 65000, 105000, 8, 'NXB Ha Noi', '2018/2/11 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Ke giet nguoi', 9655, 'Truyen Trinh Tham', 'Sach Tieng Viet', 55000, 80000, 3, 'NXB Ha Noi', '2019/12/2 17:00:00');
INSERT INTO SACH (TENSACH, MATG, TENLINHVUC, TENLOAISACH, GIAMUA, GIABIA, LANTAIBAN, TENNHAXUATBAN, NAMXUATBAN) 
VALUES ('Ke giet nguoi 2', 9655, 'Truyen Trinh Tham', 'Sach Tieng Viet', 55000, 80000, 1, 'NXB Ha Noi', '2020/12/8 19:00:00');
Select * From SACH

CREATE TRIGGER MASACHTUDONG ON SACH
INSTEAD OF INSERT
AS
DECLARE @ma char(4), @so char(3), @TENSACH nvarchar(100), @MATG int, @TENLINHVUC nvarchar(30), @TENLOAISACH nvarchar(30), 
@GIAMUA int, @GIABIA int, @LANTAIBAN int, @TENNHAXUATBAN nvarchar(50), @NAMXUATBAN datetime
SELECT @ma='SA00', @so=FLOOR(RAND()*(1000-100)+100), @TENSACH=TENSACH, @MATG=MATG, @TENLINHVUC=TENLINHVUC, @TENLOAISACH=TENLOAISACH, @GIAMUA=GIAMUA,
@GIABIA=GIABIA, @LANTAIBAN=LANTAIBAN, @TENNHAXUATBAN=TENNHAXUATBAN, @NAMXUATBAN=NAMXUATBAN
FROM INSERTED
INSERT INTO SACH 
VALUES (@ma+@so, @TENSACH, @MATG, @TENLINHVUC, @TENLOAISACH, @GIAMUA, @GIABIA, @LANTAIBAN, @TENNHAXUATBAN, @NAMXUATBAN)
GO


create table TACGIA
(
    MATG int primary key not null,
	TENTG nvarchar(40),
	NAMSINH date,
	NAMMAT date,
	QUEQUAN nvarchar(20)
)
go
INSERT INTO TACGIA VALUES ((SELECT RAND()*(10000-999)+999), 'Le Van Nam', '1976/3/8', NULL, 'Ha Noi');
INSERT INTO TACGIA VALUES ((SELECT RAND()*(10000-999)+999), 'Nguyen Van Toan', '1996/8/14', NULL, 'Hai Phong');
INSERT INTO TACGIA VALUES ((SELECT RAND()*(10000-999)+999), 'Tran Van Trung', '1932/7/1', '2014/12/22', 'TPHCM');
INSERT INTO TACGIA VALUES ((SELECT RAND()*(10000-999)+999), 'Nguyen Binh', '1969/8/9', NULL, 'Binh Dinh');
INSERT INTO TACGIA VALUES ((SELECT RAND()*(10000-999)+999), 'Ngo Van Long', '1899/12/18', '1985/8/5', 'Thanh Hoa');
Select * from TACGIA

create table TAIKHOAN
(
    USERNAME nvarchar(20) primary key not null,
	PASS_WORD nvarchar(100)
)
go
INSERT INTO TAIKHOAN VALUES ('uit', 'uit');
Select * from TAIKHOAN Where USERNAME = 'uit' and PASS_WORD = 'uit'

CREATE PROC USP_Login
@username nvarchar(20), @password nvarchar(100)
AS
BEGIN
	SELECT * FROM TAIKHOAN WHERE USERNAME = @username AND PASS_WORD = @password
END
GO


--Thêm khóa ngoại
alter table CHITIETHOADON add constraint FK_CHITIETHOADON_HOADON foreign key(MAHOADON) references HOADON(MAHOADON)
alter table CHITIETHOADON add constraint FK_CHITIETHOADON_SACH foreign key(MASACH) references SACH(MASACH)
alter table KHO add constraint FK_KHO_SACH foreign key(MASACH) references SACH(MASACH)
alter table SACH add constraint FK_SACH_LOAISACH foreign key(TENLOAISACH) references LOAISACH(TENLOAISACH)
alter table SACH add constraint FK_SACH_TACGIA foreign key(MATG) references TACGIA(MATG)
alter table SACH add constraint FK_SACH_LINHVUC foreign key(TENLINHVUC) references LINHVUC(TENLINHVUC)
alter table SACH add constraint FK_SACH_NHAXUATBAN foreign key(TENNHAXUATBAN) references NHAXUATBAN(TENNHAXUATBAN)

